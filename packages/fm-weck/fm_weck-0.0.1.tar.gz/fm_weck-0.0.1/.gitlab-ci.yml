# This file is part of fm-weck: executing fm-tools in containerized environments.
# https://gitlab.com/sosy-lab/software/fm-weck
#
# SPDX-FileCopyrightText: 2024 Dirk Beyer <https://www.sosy-lab.org>
#
# SPDX-License-Identifier: Apache-2.0

image: python:3.12-slim

stages:
  - lint
  - test
  - build
  - deploy

reuse:
  stage: lint
  allow_failure: true
  before_script:
    - python -m pip install -U reuse
  script:
    - reuse lint

lint:
  stage: lint
  before_script:
    - python -m pip install ruff
  script:
    - ruff check

test:
  variables:
    GIT_SUBMODULE_STRATEGY: normal
    GIT_SUBMODULE_DEPTH: 1
  before_script:
    - python -m pip install hatch
    - pip install .
  stage: test
  script:
    - hatch run test:cov

build:
  variables:
    GIT_SUBMODULE_STRATEGY: normal
    GIT_SUBMODULE_DEPTH: 1
  needs:
    - job: "test"
  stage: build
  before_script:
    - python -m pip install hatch
  script:
    - python -m hatch build
  artifacts:
    paths:
      - dist/*.whl

pypi:
  stage: deploy
  needs:
    - job: "build"
      artifacts: true
  script:
    - pip install -U twine
    - twine upload -u "__token__" -p "$TWINE_TOKEN" dist/*
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d{1,2}\.\d{1,2}\.[^ ]*$/'
      # Always publish tagged commits closely matching Semantic Versioning
      when: on_success
